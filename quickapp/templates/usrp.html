
{% extends 'base.html' %}
{% block title %}User Home · Quick Info{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 m-0">Welcome, {{ user.name }}</h2>
    <a class="btn btn-outline-danger" href="/logout/">Logout</a>
  </div>
  <div class="alert alert-primary">Suggested doctors for you are shown first based on your health profile. <button id="locbtn" class="btn btn-sm btn-outline-dark ms-2">Use my location</button></div>
  <div class="row g-3">
    {% for d in docd %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-1">Dr. {{ d.fname }} {{ d.lname }}</h5>
          <div class="text-muted small mb-2">{{ d.specialization }} • {{ d.hospital }}</div>
          <div class="mb-1"><strong>Fee:</strong> ₹ {{ d.price }}</div>
          <div class="text-muted small">{{ d.address }}</div>
          {% if d.distance_km %}
          <div class="mt-1"><span class="badge bg-light text-dark">~ {{ d.distance_km }} km • {{ d.eta_min }} min</span></div>
          {% endif %}
          {% if d.map_embed %}
          <div class="ratio ratio-16x9 mt-2">
            {{ d.map_embed|safe }}
          </div>
          {% endif %}
        </div>
        <div class="card-footer bg-white">
          <a class="btn btn-primary w-100" href="/usr_appointments/">Book appointment</a>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12"><div class="text-center text-muted py-4">No doctors found.</div></div>
    {% endfor %}
  </div>
{% endblock %}
{% block scripts %}
<script>
  const btn = document.getElementById('locbtn');
  if (btn && navigator.geolocation) {
    btn.addEventListener('click', () => {
      navigator.geolocation.getCurrentPosition((pos) => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/save_coords/';
        const csr = document.createElement('input');
        csr.type = 'hidden';
        csr.name = 'csrfmiddlewaretoken';
        csr.value = '{{ csrf_token }}';
        form.appendChild(csr);
        const lat = document.createElement('input');
        lat.type = 'hidden'; lat.name = 'lat'; lat.value = pos.coords.latitude;
        const lon = document.createElement('input');
        lon.type = 'hidden'; lon.name = 'lon'; lon.value = pos.coords.longitude;
        form.appendChild(lat); form.appendChild(lon);
        document.body.appendChild(form);
        form.submit();
      });
    });
  }
</script>
{% endblock %}