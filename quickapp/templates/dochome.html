{% extends 'base.html' %}
{% block title %}Doctor Dashboard · Quick Info{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 m-0">Hello, Dr. <span class="text-uppercase">{{ name }}</span></h2>
    <a class="btn btn-outline-danger" href="/logout/">Logout</a>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Today's Appointments</div>
              <div class="fs-3 fw-bold">{% with total=0 %}{% for a in apo %}{% if a.demail == doc.email %}{% with total=total|add:1 %}{% endwith %}{% endif %}{% endfor %}{{ total }}{% endwith %}</div>
            </div>
            <i class="bi bi-calendar2-week fs-1 text-primary"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Specialization</div>
          <div class="fw-semibold">{{ doc.specialization }}</div>
          <div class="text-muted">{{ doc.hospital }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Consultation Fee</div>
          <div class="fw-bold">₹ {{ doc.price }}</div>
          <div class="text-muted small">Address: {{ doc.address }}</div>
          {% if doc.map_embed %}
          <div class="ratio ratio-16x9 mt-2">
            {{ doc.map_embed|safe }}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Patient Appointments</span>
      <div class="input-group" style="width: 260px;">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="search" type="text" class="form-control" placeholder="Search patients...">
      </div>
    </div>
    <div class="table-responsive">
      <table class="table align-middle mb-0" id="apptTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Gender</th>
            <th>Age</th>
            <th style="min-width:240px">Problem</th>
            <th>Day</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for usrs in apo %}
          {% if doc.email == usrs.demail %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td class="fw-semibold">{{ usrs.pname }}</td>
            <td>{{ usrs.gender }}</td>
            <td>{{ usrs.page }}</td>
            <td><div class="text-truncate" style="max-width: 320px;">{{ usrs.problem }}</div></td>
            <td>{{ usrs.day }}</td>
            <td>{{ usrs.time }}</td>
            <td>
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal{{ forloop.counter }}">Accept</button>
              <button class="btn btn-sm btn-outline-secondary">Ignore</button>

              <div class="modal fade" id="modal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Patient Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-2"><strong>Name:</strong> {{ usrs.pname }}</div>
                      <div class="mb-2"><strong>Gender:</strong> {{ usrs.gender }}</div>
                      <div class="mb-2"><strong>Age:</strong> {{ usrs.page }}</div>
                      <div class="mb-2"><strong>Problem:</strong> {{ usrs.problem }}</div>
                      <form action="/cmsg/" method="post">
                        {% csrf_token %}
                        <label class="form-label">Message to patient</label>
                        <textarea class="form-control" name="msg" rows="3" placeholder="Type a short confirmation or instructions..."></textarea>
                        <div class="text-end mt-3">
                          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                          <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No appointments yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock %}
{% block scripts %}
<script>
  const searchInput = document.getElementById('search');
  const table = document.getElementById('apptTable');
  if (searchInput && table) {
    searchInput.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      for (const row of table.tBodies[0].rows) {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      }
    });
  }
</script>
{% endblock %}